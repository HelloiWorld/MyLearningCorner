# 目录
1. 关于APP内购，怎样处理掉单问题？
2. 手指点击屏幕，中间发生了哪些过程？
3. 关于lldb调试命令你知道多少？


## 1. 关于APP内购，怎样处理掉单问题？
支付过程如下：  
1. 调用IAP接口发起支付  
2. 支付成功，获取App Receipt票据，调用充值接口验证  
3. 验证通过，给用户充值虚拟商品并回调给App  

掉单可能会出现的场景：  
1. 完成第1步操作后，App进程因为某种原因被kill了，但可能已经扣款成功  
2. 完成第2步操作拿到票据后，由于网络原因与服务器通信失败，尚未验证票据  
3. 服务器与苹果服务器之间验证失败，需要后台设置重验逻辑  

> `[SKPaymentQueue defaultQueue]`这个队列里面存着所有的已支付、未支付的订单，而且需要手动移除，而APP每次启动的时候都会去判断这个队列里面是否为空，如果不为空的话会调用`<SKPaymentTransactionObserver>`代理的`-(void)paymentQueue:(SKPaymentQueue *)queue updatedTransactions:(NSArray *)transactions`方法，在验证成功之后移除队列`[[SKPaymentQueue defaultQueue] finishTransaction: transaction];`

应对处理如下：  
将支付凭证及相关信息存到本地，然后再去请求服务器验证，这时会出现两种情况：  
1）如果用户未卸载APP，那么在每次启动APP的时候都应该去检查是否有保存的票据信息，如果有，依次轮询交由服务器验证，验证成功之后将相应票据信息和对应事务移除  
2）如果中途用户由于卸载了APP致使本地存储丢失，沙盒里的票据信息也没了，所以要对上诉方案完善，在购买前由服务器先保存一份商品订单，用户凭借支付凭证与这份下单表作对比，如果确实为准备支付而且凭证属实，则为用户恢复数据



## 2. 手指点击屏幕，中间发生了哪些过程？
1. **生成事件**。当用户点击屏幕时，会产生一个触摸事件，并放入由Application管理的事件队列中，然后在队列中取出最前面的事件交给Window处理。
2. **查找第一响应者对象**。Window收到事件后会在视图层次结构中找到最适合的一个视图来处理事件，通常一个窗口中最适合处理当前事件的对象称为第一响应对象。
3. **处理事件**。通常最后是第一响应对象处理事件，如果第一响应对象无法处理事件，就会把事件传递给下一个响应对象，直到Application。如果Application也无法处理，那就丢弃掉此事件。  
当Application知道了第一响应对象后，就会把事件交给第一响应对象来处理，如果第一响应对象能顺利处理事件，则整个响应结束，但是第一响应对象如果无法处理事件，就会把事件传递给下一个响应对象（nextResponder），一直沿着响应链向上回溯。  
**view -> ViewController -> window -> Application -> 丢弃**


## 3. 关于lldb调试命令你知道多少？
> `expression`(可简写为`exp`/`expr`)命令是执行一个表达式，并将表达式返回的结果输出，是LLDB调试命令中最重要的命令，也是我们常用的`p`和`po`命令的鼻祖

如果提示`Unable to call function “objc_msgSend” at 0x1e7e08c: no return type information available.`这种错误，其实是要使用强制转义增加返回值类型。

### `p` & `print` & `e` & `call` 命令
这几个命令其实就是`“expression  -- “`的别名

### `po`命令 
oc里所有的对象都是用指针表示的，打印出来的是对象的指针，而不是对象本身，可以采用`-o`来打印对象本身。为了更加方便的使用，LLDB为`“expression -o —“`定了一个别名：`po`

### `bt [all]`命令
打印调用堆栈